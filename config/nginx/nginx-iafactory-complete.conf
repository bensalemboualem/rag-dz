server {
    server_name iafactoryalgeria.com;
    return 301 http://www.iafactoryalgeria.com$request_uri;
    listen [::]:443 ssl;
    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/www.iafactoryalgeria.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/www.iafactoryalgeria.com/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

server {
    server_name www.iafactoryalgeria.com;
    
    root /opt/iafactory/landing;
    index index.html;
    
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # Backend API
    location /api/ {
        proxy_pass http://127.0.0.1:8180/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }
    
    # Hub
    location /hub {
        rewrite ^/hub$ /hub/ permanent;
    }
    location /hub/ {
        proxy_pass http://127.0.0.1:8182/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        sub_filter_once off;
        sub_filter 'href="/' 'href="/hub/';
        sub_filter 'src="/' 'src="/hub/';
    }
    
    # Docs
    location /docs {
        rewrite ^/docs$ /docs/ permanent;
    }
    location /docs/ {
        proxy_pass http://127.0.0.1:8183/;
        proxy_http_version 1.1;
        proxy_set_header Host localhost;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        sub_filter_once off;
        sub_filter 'href="/' 'href="/docs/';
        sub_filter 'src="/' 'src="/docs/';
    }
    
    # Studio
    location /studio {
        rewrite ^/studio$ /studio/ permanent;
    }
    location /studio/ {
        proxy_pass http://127.0.0.1:8184/;
        proxy_http_version 1.1;
        proxy_set_header Host localhost;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        sub_filter_once off;
        sub_filter 'href="/' 'href="/studio/';
        sub_filter 'src="/' 'src="/studio/';
    }
    
    # Council
    location /council {
        rewrite ^/council$ /council/ permanent;
    }
    location /council/ {
        proxy_pass http://127.0.0.1:8185/;
        proxy_http_version 1.1;
        proxy_set_header Host localhost;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Ithy
    location /ithy {
        rewrite ^/ithy$ /ithy/ permanent;
    }
    location /ithy/ {
        proxy_pass http://127.0.0.1:8186/;
        proxy_http_version 1.1;
        proxy_set_header Host localhost;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Notebook
    location /notebook {
        rewrite ^/notebook$ /notebook/ permanent;
    }
    location /notebook/ {
        proxy_pass http://127.0.0.1:8187/;
        proxy_http_version 1.1;
        proxy_set_header Host localhost;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # BMAD
    location /bmad {
        rewrite ^/bmad$ /bmad/ permanent;
    }
    location /bmad/ {
        proxy_pass http://127.0.0.1:8188/;
        proxy_http_version 1.1;
        proxy_set_header Host localhost;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Creative
    location /creative {
        rewrite ^/creative$ /creative/ permanent;
    }
    location /creative/ {
        proxy_pass http://127.0.0.1:8189/;
        proxy_http_version 1.1;
        proxy_set_header Host localhost;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # n8n
    location /n8n {
        rewrite ^/n8n$ /n8n/ permanent;
    }
    location /n8n/ {
        proxy_pass http://127.0.0.1:8190/;
        proxy_http_version 1.1;
        proxy_set_header Host localhost;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        chunked_transfer_encoding off;
    }
    
    # RAG UI
    location /rag {
        rewrite ^/rag$ /rag/ permanent;
    }
    location /rag/ {
        proxy_pass http://127.0.0.1:8191/;
        proxy_http_version 1.1;
        proxy_set_header Host localhost;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Dashboard
    location /dashboard {
        rewrite ^/dashboard$ /dashboard/ permanent;
    }
    location /dashboard/ {
        proxy_pass http://127.0.0.1:8193/;
        proxy_http_version 1.1;
        proxy_set_header Host localhost;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Developer Studio
    location /developer {
        rewrite ^/developer$ /developer/ permanent;
    }
    location /developer/ {
        proxy_pass http://127.0.0.1:8194/;
        proxy_http_version 1.1;
        proxy_set_header Host localhost;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # DZ-Connectors API
    location /api/dz/ {
        proxy_pass http://127.0.0.1:8195/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_read_timeout 300s;
    }
    
    # Data DZ Dashboard
    location /data-dz {
        rewrite ^/data-dz$ /data-dz/ permanent;
    }
    location /data-dz/ {
        proxy_pass http://127.0.0.1:8196/;
        proxy_http_version 1.1;
        proxy_set_header Host localhost;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # DZ-LegalAssistant API
    location /api/dz-legal/ {
        proxy_pass http://127.0.0.1:8197/api/dz-legal/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 120s;
    }
    
    # DZ-LegalAssistant Frontend
    location /legal {
        rewrite ^/legal$ /legal/ permanent;
    }
    location /legal/ {
        proxy_pass http://127.0.0.1:8198/;
        proxy_http_version 1.1;
        proxy_set_header Host localhost;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # DZ-FiscalAssistant API
    location /api/dz-fiscal/ {
        proxy_pass http://127.0.0.1:8199/api/dz-fiscal/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 120s;
    }
    
    # DZ-FiscalAssistant Frontend
    location /fiscal {
        rewrite ^/fiscal$ /fiscal/ permanent;
    }
    location /fiscal/ {
        proxy_pass http://127.0.0.1:8200/;
        proxy_http_version 1.1;
        proxy_set_header Host localhost;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # DZ-VoiceAssistant API
    location /api/voice/ {
        proxy_pass http://127.0.0.1:8201/api/voice/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 120s;
        client_max_body_size 25M;
    }
    
    # DZ-VoiceAssistant Frontend
    location /voice {
        rewrite ^/voice$ /voice/ permanent;
    }
    location /voice/ {
        proxy_pass http://127.0.0.1:8202/;
        proxy_http_version 1.1;
        proxy_set_header Host localhost;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    listen [::]:443 ssl ipv6only=on;
    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/www.iafactoryalgeria.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/www.iafactoryalgeria.com/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

server {
    if ($host = www.iafactoryalgeria.com) {
        return 301 https://$host$request_uri;
    }
    listen 80;
    listen [::]:80;
    server_name www.iafactoryalgeria.com;
    return 404;
}

server {
    if ($host = iafactoryalgeria.com) {
        return 301 https://$host$request_uri;
    }
    listen 80;
    listen [::]:80;
    server_name iafactoryalgeria.com;
    return 404;
}
