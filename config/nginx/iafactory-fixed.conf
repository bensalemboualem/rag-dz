# IAFactory Algeria - Full Configuration
# Domain: www.iafactoryalgeria.com

# Redirect non-www to www
server {
    listen 80;
    listen [::]:80;
    server_name iafactoryalgeria.com;
    return 301 http://www.iafactoryalgeria.com$request_uri;
}

# Main server block
server {
    listen 80;
    listen [::]:80;
    server_name www.iafactoryalgeria.com;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Landing page (via container)
    location / {
        proxy_pass http://127.0.0.1:8192/;
        proxy_http_version 1.1;
        proxy_set_header Host localhost;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Backend API
    location /api/ {
        proxy_pass http://127.0.0.1:8180/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }

    # Hub interface - rewrite path for SPA
    location /hub {
        rewrite ^/hub$ /hub/ permanent;
    }
    location /hub/ {
        proxy_pass http://127.0.0.1:8182/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        sub_filter_once off;
        sub_filter 'href="/' 'href="/hub/';
        sub_filter 'src="/' 'src="/hub/';
    }

    # Documentation
    location /docs {
        rewrite ^/docs$ /docs/ permanent;
    }
    location /docs/ {
        proxy_pass http://127.0.0.1:8183/;
        proxy_http_version 1.1;
        proxy_set_header Host localhost;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        sub_filter_once off;
        sub_filter 'href="/' 'href="/docs/';
        sub_filter 'src="/' 'src="/docs/';
    }

    # Studio
    location /studio {
        rewrite ^/studio$ /studio/ permanent;
    }
    location /studio/ {
        proxy_pass http://127.0.0.1:8184/;
        proxy_http_version 1.1;
        proxy_set_header Host localhost;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        sub_filter_once off;
        sub_filter 'href="/' 'href="/studio/';
        sub_filter 'src="/' 'src="/studio/';
    }

    # Qdrant vector database
    location /qdrant/ {
        proxy_pass http://127.0.0.1:6333/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Direct access to backend health
    location /health {
        proxy_pass http://127.0.0.1:8180/health;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    # =====================
    # APPLICATIONS IA
    # =====================

    # Council - Configuration d'experts IA
    location /council {
        rewrite ^/council$ /council/ permanent;
    }
    location /council/ {
        proxy_pass http://127.0.0.1:8185/;
        proxy_http_version 1.1;
        proxy_set_header Host localhost;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Ithy - Recherche IA
    location /ithy {
        rewrite ^/ithy$ /ithy/ permanent;
    }
    location /ithy/ {
        proxy_pass http://127.0.0.1:8186/;
        proxy_http_version 1.1;
        proxy_set_header Host localhost;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Notebook - Interface NotebookLM
    location /notebook {
        rewrite ^/notebook$ /notebook/ permanent;
    }
    location /notebook/ {
        proxy_pass http://127.0.0.1:8187/;
        proxy_http_version 1.1;
        proxy_set_header Host localhost;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # BMAD - Business Plan
    location /bmad {
        rewrite ^/bmad$ /bmad/ permanent;
    }
    location /bmad/ {
        proxy_pass http://127.0.0.1:8188/;
        proxy_http_version 1.1;
        proxy_set_header Host localhost;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # Studio Créatif - Création contenu social media
    location /creative {
        rewrite ^/creative$ /creative/ permanent;
    }
    location /creative/ {
        proxy_pass http://127.0.0.1:8189/;
        proxy_http_version 1.1;
        proxy_set_header Host localhost;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # n8n - Workflow Automation
    location /n8n {
        rewrite ^/n8n$ /n8n/ permanent;
    }
    location /n8n/ {
        proxy_pass http://127.0.0.1:8190/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_buffering off;
        proxy_cache off;
        chunked_transfer_encoding off;
    }

    # RAG - Retrieval Augmented Generation
    location /rag {
        rewrite ^/rag$ /rag/ permanent;
    }
    location /rag/ {
# Archon UI - Multi-Agent Interface    location /archon-ui {        rewrite ^/archon-ui$ /archon-ui/ permanent;    }    location /archon-ui/ {        alias /opt/iafactory-rag-dz/frontend/archon-ui/dist/;        try_files  / /archon-ui/index.html;                # Cache assets        location ~* .(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {            expires 1y;            add_header Cache-Control "public, immutable";        }    }
        proxy_pass http://127.0.0.1:8191/;
# Archon UI - Multi-Agent Interface    location /archon-ui {        rewrite ^/archon-ui$ /archon-ui/ permanent;    }    location /archon-ui/ {        alias /opt/iafactory-rag-dz/frontend/archon-ui/dist/;        try_files  / /archon-ui/index.html;                # Cache assets        location ~* .(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {            expires 1y;            add_header Cache-Control "public, immutable";        }    }
        proxy_http_version 1.1;
# Archon UI - Multi-Agent Interface    location /archon-ui {        rewrite ^/archon-ui$ /archon-ui/ permanent;    }    location /archon-ui/ {        alias /opt/iafactory-rag-dz/frontend/archon-ui/dist/;        try_files  / /archon-ui/index.html;                # Cache assets        location ~* .(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {            expires 1y;            add_header Cache-Control "public, immutable";        }    }
        proxy_set_header Host localhost;
# Archon UI - Multi-Agent Interface    location /archon-ui {        rewrite ^/archon-ui$ /archon-ui/ permanent;    }    location /archon-ui/ {        alias /opt/iafactory-rag-dz/frontend/archon-ui/dist/;        try_files  / /archon-ui/index.html;                # Cache assets        location ~* .(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {            expires 1y;            add_header Cache-Control "public, immutable";        }    }
        proxy_set_header X-Real-IP $remote_addr;
# Archon UI - Multi-Agent Interface    location /archon-ui {        rewrite ^/archon-ui$ /archon-ui/ permanent;    }    location /archon-ui/ {        alias /opt/iafactory-rag-dz/frontend/archon-ui/dist/;        try_files  / /archon-ui/index.html;                # Cache assets        location ~* .(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {            expires 1y;            add_header Cache-Control "public, immutable";        }    }
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
# Archon UI - Multi-Agent Interface    location /archon-ui {        rewrite ^/archon-ui$ /archon-ui/ permanent;    }    location /archon-ui/ {        alias /opt/iafactory-rag-dz/frontend/archon-ui/dist/;        try_files  / /archon-ui/index.html;                # Cache assets        location ~* .(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {            expires 1y;            add_header Cache-Control "public, immutable";        }    }
        proxy_set_header X-Forwarded-Proto $scheme;
# Archon UI - Multi-Agent Interface    location /archon-ui {        rewrite ^/archon-ui$ /archon-ui/ permanent;    }    location /archon-ui/ {        alias /opt/iafactory-rag-dz/frontend/archon-ui/dist/;        try_files  / /archon-ui/index.html;                # Cache assets        location ~* .(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {            expires 1y;            add_header Cache-Control "public, immutable";        }    }
        proxy_set_header Upgrade $http_upgrade;
# Archon UI - Multi-Agent Interface    location /archon-ui {        rewrite ^/archon-ui$ /archon-ui/ permanent;    }    location /archon-ui/ {        alias /opt/iafactory-rag-dz/frontend/archon-ui/dist/;        try_files  / /archon-ui/index.html;                # Cache assets        location ~* .(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {            expires 1y;            add_header Cache-Control "public, immutable";        }    }
        proxy_set_header Connection "upgrade";
# Archon UI - Multi-Agent Interface    location /archon-ui {        rewrite ^/archon-ui$ /archon-ui/ permanent;    }    location /archon-ui/ {        alias /opt/iafactory-rag-dz/frontend/archon-ui/dist/;        try_files  / /archon-ui/index.html;                # Cache assets        location ~* .(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {            expires 1y;            add_header Cache-Control "public, immutable";        }    }
    }
# Archon UI - Multi-Agent Interface    location /archon-ui {        rewrite ^/archon-ui$ /archon-ui/ permanent;    }    location /archon-ui/ {        alias /opt/iafactory-rag-dz/frontend/archon-ui/dist/;        try_files  / /archon-ui/index.html;                # Cache assets        location ~* .(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {            expires 1y;            add_header Cache-Control "public, immutable";        }    }

    # Archon UI - Multi-Agent Interface
    location /archon-ui {
        rewrite ^/archon-ui$ /archon-ui/ permanent;
    }
    location /archon-ui/ {
        alias /opt/iafactory-rag-dz/frontend/archon-ui/dist/;
        index index.html;
        try_files $uri $uri/ /archon-ui/index.html;
    }

}

    }
