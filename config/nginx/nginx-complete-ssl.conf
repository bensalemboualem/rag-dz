# Map for WebSocket upgrade
map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

# HTTP → HTTPS redirect
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name www.iafactoryalgeria.com iafactoryalgeria.com _;

    # Ollama API proxy (for local AI via HTTP) - direct access on port 80
    location ^~ /ollama/ {
        proxy_pass http://127.0.0.1:11434/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }

    # Redirect other requests to HTTPS
    location / {
        return 301 https://www.iafactoryalgeria.com$request_uri;
    }
}

# HTTPS server
server {
    listen 443 ssl http2;
    server_name www.iafactoryalgeria.com iafactoryalgeria.com;

    # SSL Configuration
    ssl_certificate /etc/letsencrypt/live/www.iafactoryalgeria.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/www.iafactoryalgeria.com/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    root /opt/iafactory-rag-dz/apps;
    index index.html;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Ollama API proxy (for local AI models)
    location ^~ /ollama/ {
        proxy_pass http://127.0.0.1:11434/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }

    # Studio (Bolt.DIY)
    location /studio {
        rewrite ^/studio$ /studio/ permanent;
    }
    location /studio/ {
        proxy_pass http://127.0.0.1:8184/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Bolt.DIY - AI Code Generator
    location /bolt {
        rewrite ^/bolt$ /bolt/ permanent;
    }
    location /bolt/ {
        proxy_pass http://127.0.0.1:5173/;
        proxy_http_version 1.1;
        proxy_set_header Host localhost;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }

    # Hub
    location /hub {
        rewrite ^/hub$ /hub/ permanent;
    }
    location /hub/ {
        proxy_pass http://127.0.0.1:8182/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # Council - Configuration d'experts IA
    location /council {
        rewrite ^/council$ /council/ permanent;
    }
    location /council/ {
        proxy_pass http://127.0.0.1:8185/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Ithy - Recherche IA
    location /ithy {
        rewrite ^/ithy$ /ithy/ permanent;
    }
    location /ithy/ {
        proxy_pass http://127.0.0.1:8186/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Notebook - Interface NotebookLM
    location /notebook {
        rewrite ^/notebook$ /notebook/ permanent;
    }
    location /notebook/ {
        proxy_pass http://127.0.0.1:8187/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # BMAD - Business Plan
    location /bmad {
        rewrite ^/bmad$ /bmad/ permanent;
    }
    location /bmad/ {
        proxy_pass http://127.0.0.1:8188/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # Studio Créatif - Création contenu social media
    location /creative {
        rewrite ^/creative$ /creative/ permanent;
    }
    location /creative/ {
        proxy_pass http://127.0.0.1:8189/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # n8n - Workflow Automation
    location /n8n {
        rewrite ^/n8n$ /n8n/ permanent;
    }
    location /n8n/ {
        proxy_pass http://127.0.0.1:8190/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_buffering off;
        proxy_cache off;
        chunked_transfer_encoding off;
    }

    # RAG - Retrieval Augmented Generation
    location /rag {
        rewrite ^/rag$ /rag/ permanent;
    }
    location /rag/ {
        proxy_pass http://127.0.0.1:8191/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # Archon UI - Static files (old path)
    location /archon/ {
        alias /opt/iafactory-rag-dz/frontend/archon-ui/dist/;
        try_files $uri $uri/ /archon/index.html;
    }

    # Archon UI - Container (new path)
    location /archon-ui/ {
        proxy_pass http://127.0.0.1:9999/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }

    # RAG UI
    location /rag-ui/ {
        alias /opt/iafactory-rag-dz/frontend/rag-ui/dist/;
        try_files $uri $uri/ /rag-ui/index.html;
    }

    # API Backend
    location /api/ {
        proxy_pass http://127.0.0.1:8180/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }

    # WebSocket
    location /ws {
        proxy_pass http://127.0.0.1:8180/ws;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Growth Grid - Business Plan Generator
    location /apps/growth-grid/ {
        alias /opt/iafactory-rag-dz/apps/growth-grid/;
        try_files $uri $uri/ /apps/growth-grid/frontend/index.html;
    }

    # Notebook LM IAFactory - RAG Documents
    location /apps/notebook-lm/ {
        alias /opt/iafactory-rag-dz/apps/notebook-lm/;
        try_files $uri $uri/ /apps/notebook-lm/frontend/index.html;
    }

    # Prompt Creator Pro
    location /apps/prompt-creator/ {
        alias /opt/iafactory-rag-dz/apps/prompt-creator/;
        try_files $uri $uri/ /apps/prompt-creator/index.html;
    }

    # AI Searcher
    location /apps/ai-searcher/ {
        alias /opt/iafactory-rag-dz/apps/ai-searcher/;
        try_files $uri $uri/ /apps/ai-searcher/index.html;
    }

    # Apps statiques (MUST BE LAST)
    location / {
        try_files $uri $uri/ $uri/index.html /landing/index.html;
    }
}
