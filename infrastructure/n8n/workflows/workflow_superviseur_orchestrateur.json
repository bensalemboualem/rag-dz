{
  "name": "Superviseur Orchestrateur BMAD",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 5
            }
          ]
        }
      },
      "id": "schedule-supervisor",
      "name": "Planification 5 min",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        240,
        300
      ]
    },
    {
      "parameters": {
        "url": "={{ $env.BACKEND_URL || 'http://backend:8180' }}/api/orchestrator/pending-workflows?limit=25",
        "options": {
          "timeout": 15000
        },
        "headerParametersUi": {
          "parameter": [
            {
              "name": "X-API-Key",
              "value": "={{ $env.API_KEY || 'change-me-in-production' }}"
            }
          ]
        }
      },
      "id": "fetch-pending",
      "name": "R√©cup√©rer backlog",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        460,
        300
      ]
    },
    {
      "parameters": {
        "functionCode": "const pending = $json.pending || [];\nif (!Array.isArray(pending) || pending.length === 0) {\n  return [];\n}\nreturn pending.map(item => ({ json: item }));"
      },
      "id": "expand-pending",
      "name": "D√©plier orchestrations",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        700,
        300
      ]
    },
    {
      "parameters": {
        "functionCode": "const ageMinutes = $json.age_minutes ?? 0;\nconst needsRecovery = ($json.status === 'failed') || ageMinutes > 15;\nconst needsHuman = (!$json.project_ready && ($json.missing_signals || []).length > 0);\nreturn [\n  {\n    json: {\n      ...$json,\n      needs_recovery: needsRecovery,\n      needs_human: needsHuman,\n      age_minutes: ageMinutes\n    }\n  }\n];"
      },
      "id": "tag-decisions",
      "name": "Annoter d√©cisions",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        920,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "leftValue": "={{ $json.needs_recovery }}",
              "rightValue": true
            }
          ]
        }
      },
      "id": "if-recovery",
      "name": "Reprise automatique?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1160,
        200
      ]
    },
    {
      "parameters": {
        "url": "={{ $env.BACKEND_URL || 'http://backend:8180' }}/api/orchestrator/pending-workflows/{{$json.id}}/recover",
        "method": "POST",
        "headerParametersUi": {
          "parameter": [
            {
              "name": "X-API-Key",
              "value": "={{ $env.API_KEY || 'change-me-in-production' }}"
            }
          ]
        }
      },
      "id": "http-recover",
      "name": "Relancer orchestration",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1380,
        120
      ]
    },
    {
      "parameters": {
        "channel": "={{ $env.SLACK_CHANNEL || '#ops-ragdz' }}",
        "text": "üîÅ *Relance auto orchestrateur*\\n‚Ä¢ Projet: {{$json.project_id}}\\n‚Ä¢ State: {{$json.id}}\\n‚Ä¢ Status pr√©c√©dent: {{$json.status}}\\n‚Ä¢ √Çge: {{$json.age_minutes}} min\\n‚Ä¢ Manques: {{ ($json.missing_signals || []).join(', ') || 'aucun' }}",
        "otherOptions": {}
      },
      "id": "slack-recovery",
      "name": "Notifier relance",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.2,
      "position": [
        1600,
        120
      ],
      "credentials": {
        "slackApi": {
          "id": "slack-credentials",
          "name": "Slack"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "leftValue": "={{ $json.needs_human }}",
              "rightValue": true
            }
          ]
        }
      },
      "id": "if-human",
      "name": "Escalade humaine?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1160,
        420
      ]
    },
    {
      "parameters": {
        "channel": "={{ $env.SLACK_CHANNEL || '#ops-ragdz' }}",
        "text": "‚ö†Ô∏è *Intervention requise*\\n‚Ä¢ Projet: {{$json.project_id}}\\n‚Ä¢ State: {{$json.id}}\\n‚Ä¢ Statut: {{$json.status}}\\n‚Ä¢ Signaux manquants: {{ ($json.missing_signals || []).join(', ') }}\\n‚Ä¢ Agents consult√©s: {{ ($json.agents_consulted || []).join(', ') }}\\n‚Ä¢ Messages: {{$json.messages_count}}",
        "otherOptions": {}
      },
      "id": "slack-human",
      "name": "Alerter √©quipe",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.2,
      "position": [
        1380,
        420
      ],
      "credentials": {
        "slackApi": {
          "id": "slack-credentials",
          "name": "Slack"
        }
      }
    }
  ],
  "connections": {
    "Planification 5 min": {
      "main": [
        [
          {
            "node": "R√©cup√©rer backlog",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "R√©cup√©rer backlog": {
      "main": [
        [
          {
            "node": "D√©plier orchestrations",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "D√©plier orchestrations": {
      "main": [
        [
          {
            "node": "Annoter d√©cisions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Annoter d√©cisions": {
      "main": [
        [
          {
            "node": "Reprise automatique?",
            "type": "main",
            "index": 0
          },
          {
            "node": "Escalade humaine?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reprise automatique?": {
      "main": [
        [
          {
            "node": "Relancer orchestration",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Relancer orchestration": {
      "main": [
        [
          {
            "node": "Notifier relance",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Escalade humaine?": {
      "main": [
        [
          {
            "node": "Alerter √©quipe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "name": "Supervisor"
    },
    {
      "name": "BMAD"
    }
  ],
  "triggerCount": 0,
  "versionId": "1"
}

