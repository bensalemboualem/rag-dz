# =============================================================================
# ALERTMANAGER CONFIGURATION - iaFactory Algeria
# Gestion des alertes et notifications
# =============================================================================

global:
  # Timeout pour rÃ©soudre une alerte
  resolve_timeout: 5m
  
  # Configuration SMTP pour emails (Ã  personnaliser)
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'alertes@iafactoryalgeria.com'
  smtp_auth_username: 'alertes@iafactoryalgeria.com'
  smtp_auth_password: 'your-app-password'  # Ã€ configurer
  smtp_require_tls: true

# Templates personnalisÃ©s
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# Route principale
route:
  # Grouper par alertname et service
  group_by: ['alertname', 'service', 'severity']
  
  # Attendre avant d'envoyer la premiÃ¨re notification
  group_wait: 30s
  
  # Intervalle entre notifications pour le mÃªme groupe
  group_interval: 5m
  
  # Intervalle de rÃ©pÃ©tition
  repeat_interval: 4h
  
  # Receiver par dÃ©faut
  receiver: 'iafactory-team'
  
  # Routes spÃ©cifiques
  routes:
    # Alertes critiques -> notification immÃ©diate
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 10s
      repeat_interval: 1h
      continue: true
    
    # Alertes infrastructure
    - match:
        team: devops
      receiver: 'devops-team'
      group_wait: 1m
    
    # Alertes backend
    - match:
        team: backend
      receiver: 'backend-team'
      group_wait: 1m

# Inhibit rules - Ã©viter les alertes redondantes
inhibit_rules:
  # Si critique, supprimer le warning correspondant
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'service']
  
  # Si le node est down, supprimer les alertes conteneurs
  - source_match:
      alertname: 'NodeDown'
    target_match_re:
      alertname: 'Container.*'
    equal: ['instance']

# Receivers - Destinations des alertes
receivers:
  # Team principale
  - name: 'iafactory-team'
    webhook_configs:
      # Webhook vers n8n pour traitement personnalisÃ©
      - url: 'http://n8n:5678/webhook/alertmanager'
        send_resolved: true
    # Email (optionnel)
    # email_configs:
    #   - to: 'team@iafactoryalgeria.com'
    #     send_resolved: true

  # Alertes critiques
  - name: 'critical-alerts'
    webhook_configs:
      # Webhook vers n8n
      - url: 'http://n8n:5678/webhook/critical-alerts'
        send_resolved: true
    # Telegram Bot (Ã  configurer)
    # telegram_configs:
    #   - bot_token: 'YOUR_BOT_TOKEN'
    #     chat_id: YOUR_CHAT_ID
    #     message: |
    #       ðŸš¨ *ALERTE CRITIQUE* ðŸš¨
    #       *{{ .GroupLabels.alertname }}*
    #       {{ range .Alerts }}
    #       {{ .Annotations.summary }}
    #       {{ .Annotations.description }}
    #       {{ end }}

  # DevOps team
  - name: 'devops-team'
    webhook_configs:
      - url: 'http://n8n:5678/webhook/devops-alerts'
        send_resolved: true

  # Backend team
  - name: 'backend-team'
    webhook_configs:
      - url: 'http://n8n:5678/webhook/backend-alerts'
        send_resolved: true

  # Null receiver pour tests
  - name: 'null'
