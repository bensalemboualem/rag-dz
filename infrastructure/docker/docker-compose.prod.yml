# =============================================================================
# IA FACTORY - PRODUCTION DOCKER COMPOSE
# Déploiement Hetzner / Algérie Télécom
# =============================================================================
# Usage:
#   docker-compose -f docker-compose.prod.yml up -d
#   docker-compose -f docker-compose.prod.yml logs -f
# =============================================================================

services:
  # =====================================================
  # FRONTEND - Bolt-DIY (IAF Studio)
  # =====================================================
  iafactory-frontend:
    build:
      context: ./bolt-diy
      dockerfile: Dockerfile
      args:
        NODE_ENV: production
    container_name: iaf-studio-prod
    environment:
      NODE_ENV: production
      VITE_API_URL: ${VITE_API_URL:-http://localhost:8181}
      VITE_WS_URL: ${VITE_WS_URL:-ws://localhost:8181/ws}
      # LLM Keys (pour appels directs depuis le frontend si nécessaire)
      GROQ_API_KEY: ${GROQ_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
    ports:
      - "3000:5173"
    depends_on:
      iafactory-backend:
        condition: service_healthy
    networks:
      - iaf-prod-network
    restart: always
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:5173"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 256M

  # =====================================================
  # BACKEND - Archon RAG (FastAPI)
  # =====================================================
  iafactory-backend:
    build:
      context: ./backend/rag-compat
      dockerfile: Dockerfile
    container_name: iaf-backend-prod
    command: python main.py
    environment:
      # === Service ===
      SERVICE_NAME: archon-rag-sovereign
      SERVICE_VERSION: 1.0.0
      ENVIRONMENT: production
      LOG_LEVEL: ${LOG_LEVEL:-INFO}

      # === Database - Supabase/PGVector ===
      SUPABASE_URL: ${SUPABASE_URL:-}
      SUPABASE_KEY: ${SUPABASE_KEY:-}
      POSTGRES_URL: ${POSTGRES_URL:-postgresql://postgres:${POSTGRES_PASSWORD}@postgres-prod:5432/archon}
      USE_PGVECTOR: "true"

      # === Redis Cache ===
      REDIS_URL: redis://redis-cache:6379/0
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}

      # === Qdrant (optionnel, PGVector prioritaire) ===
      QDRANT_HOST: ${QDRANT_HOST:-}
      QDRANT_PORT: ${QDRANT_PORT:-6333}

      # === LLM Providers ===
      ENABLE_LLM: "true"
      LLM_PROVIDER: ${LLM_PROVIDER:-groq}
      LLM_MODEL: ${LLM_MODEL:-llama-3.3-70b-versatile}
      GROQ_API_KEY: ${GROQ_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY:-}

      # === Embeddings ===
      EMBEDDING_MODEL: ${EMBEDDING_MODEL:-sentence-transformers/paraphrase-multilingual-mpnet-base-v2}
      EMBEDDING_DEVICE: ${EMBEDDING_DEVICE:-cpu}
      EMBEDDING_BATCH_SIZE: ${EMBEDDING_BATCH_SIZE:-32}

      # === Reranking ===
      USE_RERANKING: ${USE_RERANKING:-true}
      RERANKING_MODEL: ${RERANKING_MODEL:-cross-encoder/ms-marco-MiniLM-L-6-v2}
      RERANKING_TOP_K: ${RERANKING_TOP_K:-10}

      # === Security ===
      API_SECRET_KEY: ${API_SECRET_KEY:?API_SECRET_KEY is required}
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-https://iafactory.dz,https://app.iafactory.ch}
      ENABLE_CORS: "true"
      ENABLE_API_KEY_AUTH: "true"

      # === Rate Limiting ===
      ENABLE_RATE_LIMITING: "true"
      RATE_LIMIT_PER_MINUTE: ${RATE_LIMIT_PER_MINUTE:-120}
      RATE_LIMIT_PER_HOUR: ${RATE_LIMIT_PER_HOUR:-3000}

      # === Metrics ===
      ENABLE_METRICS: "true"

    ports:
      - "8181:8181"
    volumes:
      - backend_models:/root/.cache  # Cache des modèles embeddings
      - ./bmad:/bmad:ro              # BMAD method (lecture seule)
    depends_on:
      redis-cache:
        condition: service_healthy
      postgres-prod:
        condition: service_healthy
    networks:
      - iaf-prod-network
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8181/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2.0'
        reservations:
          memory: 1G

  # =====================================================
  # REDIS - Cache RAG
  # =====================================================
  redis-cache:
    image: redis:7-alpine
    container_name: iaf-redis-prod
    command: >
      redis-server
      --appendonly yes
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --requirepass ${REDIS_PASSWORD:-}
    volumes:
      - redis_prod_data:/data
    ports:
      - "6379:6379"
    networks:
      - iaf-prod-network
    restart: always
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-}", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'

  # =====================================================
  # POSTGRESQL + PGVECTOR (Si pas Supabase)
  # =====================================================
  postgres-prod:
    image: pgvector/pgvector:pg16
    container_name: iaf-postgres-prod
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      POSTGRES_DB: ${POSTGRES_DB:-archon}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_prod_data:/var/lib/postgresql/data
      - ./infrastructure/sql/init.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
      - ./infrastructure/sql/pgvector_migration.sql:/docker-entrypoint-initdb.d/02-pgvector.sql:ro
    ports:
      - "5432:5432"
    command: >
      postgres
      -c shared_preload_libraries=vector
      -c max_connections=200
      -c shared_buffers=256MB
      -c effective_cache_size=768MB
      -c maintenance_work_mem=128MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c work_mem=4MB
      -c min_wal_size=1GB
      -c max_wal_size=4GB
    networks:
      - iaf-prod-network
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-archon}"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.5'
        reservations:
          memory: 512M

  # =====================================================
  # KEY SERVICE - Firebase (Optionnel)
  # =====================================================
  key-service:
    build:
      context: ./backend/key-service
      dockerfile: Dockerfile
    container_name: iaf-keys-prod
    environment:
      PORT: 3001
      NODE_ENV: production
      # Firebase credentials via .env ou secrets
      FIREBASE_API_KEY: ${FIREBASE_API_KEY:-}
      FIREBASE_AUTH_DOMAIN: ${FIREBASE_AUTH_DOMAIN:-}
      FIREBASE_PROJECT_ID: ${FIREBASE_PROJECT_ID:-}
    ports:
      - "3002:3001"
    networks:
      - iaf-prod-network
    restart: always
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    profiles:
      - keys
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'

  # =====================================================
  # NGINX REVERSE PROXY (Optionnel - recommandé)
  # =====================================================
  nginx:
    image: nginx:alpine
    container_name: iaf-nginx-prod
    volumes:
      - ./infrastructure/nginx/nginx.prod.conf:/etc/nginx/nginx.conf:ro
      - ./infrastructure/nginx/ssl:/etc/nginx/ssl:ro
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - iafactory-frontend
      - iafactory-backend
    networks:
      - iaf-prod-network
    restart: always
    profiles:
      - proxy
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.25'

# =====================================================
# NETWORKS
# =====================================================
networks:
  iaf-prod-network:
    driver: bridge
    name: iaf-production
    ipam:
      config:
        - subnet: 172.28.0.0/16

# =====================================================
# VOLUMES
# =====================================================
volumes:
  postgres_prod_data:
    name: iaf-postgres-prod-data
  redis_prod_data:
    name: iaf-redis-prod-data
  backend_models:
    name: iaf-backend-models
